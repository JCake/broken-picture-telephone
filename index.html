<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Broken Picture Telephone</title>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
         https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-storage.js"></script>

    <script type="text/javascript">
      // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyAv2cuZwaiwrEX6QyqOtlfNdnQvEzrrobs",
        authDomain: "broken-picture-telephone.firebaseapp.com",
        databaseURL: "https://broken-picture-telephone.firebaseio.com",
        projectId: "broken-picture-telephone",
        storageBucket: "broken-picture-telephone.appspot.com",
        messagingSenderId: "412493867376",
        appId: "1:412493867376:web:327310ab5d6ddef48807b5",
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);

      console.log(firebase.app().name);
      const db = firebase.firestore();

      let mode = "setup";
      let drawPrompt;
      let myCanvas;
      let textPrompt;
      let inputPhrase;

      let myContext;
      let clickX = [];
      let clickY = [];
      let clickDrag = [];
      let paint;
      let usingMouse;
      let usingPointer;
      let offsetLeft = 4;
      let offsetTop = 16;
      //http://www.williammalone.com/articles/create-html5-canvas-javascript-drawing-app/
      function setUp() {
        drawPrompt = document.getElementById("drawPrompt");
        myCanvas = document.getElementById("drawingCanvas");
        textPrompt = document.getElementById("textPrompt");
        inputPhrase = document.getElementById("inputPhrase");
        submitButton = document.getElementById("submitButton");

        drawPrompt.style.display = "none";
        myCanvas.style.display = "none";
        textPrompt.innerHTML = "Enter your game id";

        myContext = myCanvas.getContext("2d");

        myCanvas.addEventListener("mousedown", (e) => {
          if (mode === "draw") {
            const mouseX = e.pageX - offsetLeft;
            const mouseY = e.pageY - offsetTop;
            paint = true;
            usingMouse = true;
            addClick(mouseX, mouseY);
            redraw();
          }
        });
        myCanvas.addEventListener("mousemove", (e) => {
          if (paint) {
            addClick(e.pageX - offsetLeft, e.pageY - offsetTop, true);
            redraw();
          }
        });
        myCanvas.addEventListener("mouseup", () => {
          if (usingMouse) {
            paint = false;
            usingMouse = false;
          }
        });
        myCanvas.addEventListener("mouseleave", () => {
          if (usingMouse) {
            paint = false;
            usingMouse = false;
          }
        });

        myCanvas.addEventListener("touchstart", (e) => {
          if (mode === "draw") {
            const mouseX = e.touches[0].pageX - offsetLeft;
            const mouseY = e.touches[0].pageY - offsetTop;
            paint = true;
            usingPointer = true;
            addClick(mouseX, mouseY);
            redraw();
          }
        });
        myCanvas.addEventListener("touchmove", (e) => {
          if (paint) {
            addClick(
              e.touches[0].pageX - offsetLeft,
              e.touches[0].pageY - offsetTop,
              true
            );
            redraw();
          }
        });

        myCanvas.addEventListener("touchend", () => {
          if (usingPointer) {
            paint = false;
            usingPointer = false;
          }
        });
      }

      function addClick(x, y, dragging) {
        clickX.push(x);
        clickY.push(y);
        clickDrag.push(dragging);
      }

      function redraw(
        context = myContext,
        clickXToUse = clickX,
        clickYToUse = clickY,
        clickDragToUse = clickDrag
      ) {
        if (context !== myContext) {
          console.log(myContext);
          console.log(context);
          console.log(clickXToUse);
          console.log(clickYToUse);
          console.log(clickDragToUse);
        }

        context.clearRect(0, 0, context.canvas.width, context.canvas.height); // Clears the canvas

        context.strokeStyle = "#df4b26";
        context.lineJoin = "round";
        context.lineWidth = 5;

        for (var i = 0; i < clickXToUse.length; i++) {
          context.beginPath();
          if (clickDragToUse[i] && i) {
            context.moveTo(clickXToUse[i - 1], clickYToUse[i - 1]);
          } else {
            context.moveTo(clickXToUse[i] - 1, clickYToUse[i]);
          }
          context.lineTo(clickXToUse[i], clickYToUse[i]);
          context.closePath();
          context.stroke();
        }
      }

      let gameId;
      let userId = Math.ceil(Math.random() * 50000);
      let receiveFrom;
      let sendTo;
      let startedPlayerIdSteps = new Map();
      let promptNeedingMyResponse;
      let MAX_STEP = 7;
      function submit() {
        if (mode == "setup") {
          if (!gameId) {
            gameId = inputPhrase.value;
            db.collection("players-" + gameId).add({
              playerId: userId,
            });
            inputPhrase.style.display = "none";
            inputPhrase.value = "";
            textPrompt.innerHTML =
              "Click submit when all players have entered the game id";
          } else {
            // Check for existing prompts before beginning:
            db.collection("prompts-" + gameId)
              .get()
              .then((querySnapshot) => {
                const prompts = [];
                querySnapshot.forEach((doc) => prompts.push(doc.data()));
                if (prompts.length >= MAX_STEP) {
                  textPrompt.innerHTML =
                    "Game already completed or in progress.  Results below.";
                  submitButton.style.display = "none";
                  mode === "reveal";
                  displayResults(prompts);
                } else {
                  mode = "initial";
                  textPrompt.innerHTML = "Enter a phrase";
                  inputPhrase.style.display = "block";
                  db.collection("players-" + gameId)
                    .get()
                    .then((querySnapshot) => {
                      let players = [];
                      querySnapshot.forEach((doc) =>
                        players.push(doc.data().playerId)
                      );
                      players = players.sort();
                      const yourIndex = players.indexOf(userId);
                      receiveFrom =
                        players[
                          yourIndex >= 1 ? yourIndex - 1 : players.length - 1
                        ];
                      sendTo =
                        players[
                          yourIndex < players.length - 1 ? yourIndex + 1 : 0
                        ];
                      players.forEach((player) =>
                        startedPlayerIdSteps.set(player, 0)
                      );
                    });
                }
              });
          }
        } else if (mode === "initial") {
          db.collection("prompts-" + gameId).add({
            prompt: inputPhrase.value,
            clickX: null,
            clickY: null,
            clickDrag: null,
            submittedPlayerId: userId,
            receivingPlayerId: sendTo,
            startedPlayerId: userId,
            step: 1,
          });
          this.handleWaitingForPrompt();
        } else if (mode === "draw") {
          db.collection("prompts-" + gameId).add({
            prompt: null,
            clickX: clickX.join(","),
            clickY: clickY.join(","),
            clickDrag: clickDrag.join(","),
            submittedPlayerId: userId,
            receivingPlayerId: sendTo,
            startedPlayerId: promptNeedingMyResponse.startedPlayerId,
            step: promptNeedingMyResponse.step + 1,
          });
          this.handleWaitingForPrompt();
        } else if (mode === "write") {
          db.collection("prompts-" + gameId).add({
            prompt: inputPhrase.value,
            clickX: null,
            clickY: null,
            clickDrag: null,
            submittedPlayerId: userId,
            receivingPlayerId: sendTo,
            startedPlayerId: promptNeedingMyResponse.startedPlayerId,
            step: promptNeedingMyResponse.step + 1,
          });
          this.handleWaitingForPrompt();
        }
      }

      function handleWaitingForPrompt() {
        textPrompt.style.display = "block";
        textPrompt.innerHTML = "Waiting for other player";
        drawPrompt.style.display = "none";
        myCanvas.style.display = "none";
        inputPhrase.style.display = "none";
        submitButton.style.display = "none";
        const checkForPrompts = setInterval(() => {
          db.collection("prompts-" + gameId)
            .get()
            .then((querySnapshot) => {
              const prompts = [];
              querySnapshot.forEach((doc) => prompts.push(doc.data()));
              if (prompts.length >= MAX_STEP * startedPlayerIdSteps.size) {
                mode === "reveal";
                document.getElementById("duringGame").style.display = "none";
                clearInterval(checkForPrompts);
                displayResults(prompts);
              } else {
                const promptsForMe = prompts.filter(
                  (prompt) =>
                    prompt.submittedPlayerId === receiveFrom &&
                    prompt.receivingPlayerId === userId
                );
                promptNeedingMyResponse = promptsForMe.find(
                  (prompt) =>
                    startedPlayerIdSteps.get(prompt.startedPlayerId) <
                      prompt.step && prompt.step < MAX_STEP
                );
                if (promptNeedingMyResponse) {
                  clearInterval(checkForPrompts);
                  myCanvas.style.display = "block";
                  submitButton.style.display = "block";
                  startedPlayerIdSteps.set(
                    promptNeedingMyResponse.startedPlayerId,
                    promptNeedingMyResponse.step
                  );
                  if (promptNeedingMyResponse.clickX) {
                    clickX = promptNeedingMyResponse.clickX
                      .split(",")
                      .map((n) => parseInt(n));
                    clickY = promptNeedingMyResponse.clickY
                      .split(",")
                      .map((n) => parseInt(n));
                    clickDrag = promptNeedingMyResponse.clickDrag
                      .split(",")
                      .map((b) => b === "true");
                    redraw();
                    textPrompt.innerHTML = "What is this?";
                    inputPhrase.value = "";
                    drawPrompt.style.display = "none";
                    textPrompt.style.display = "block";
                    inputPhrase.style.display = "block";
                    mode = "write";
                  } else {
                    document.getElementById("picturePhrase").innerHTML =
                      promptNeedingMyResponse.prompt;
                    myContext.clearRect(
                      0,
                      0,
                      myContext.canvas.width,
                      myContext.canvas.height
                    ); // Clears the canvas
                    clickX = [];
                    clickY = [];
                    clickDrag = [];
                    drawPrompt.style.display = "block";
                    textPrompt.style.display = "none";
                    inputPhrase.style.display = "none";
                    mode = "draw";
                  }
                }
              }
            });
        }, 1500);
      }

      function displayResults(prompts) {
        const startingPlayerToPrompts = new Map();
        prompts.forEach((prompt) => {
          if (!startingPlayerToPrompts.get(prompt.startedPlayerId)) {
            startingPlayerToPrompts.set(prompt.startedPlayerId, []);
          }
          startingPlayerToPrompts.get(prompt.startedPlayerId).push(prompt);
        });
        startingPlayerToPrompts.forEach((value, key) => {
          const promptsInOrder = value.sort(
            (prompt1, prompt2) => prompt1.step - prompt2.step
          );
          const afterGameDiv0 = document.getElementById("afterGame");
          const title = document.createElement("p");
          title.innerText = `Chain ${key}`;
          afterGameDiv0.appendChild(title);
          promptsInOrder.forEach((prompt) => {
            const afterGameDiv = document.getElementById("afterGame");
            if (prompt.clickX) {
              const canv = document.createElement("canvas");
              canv.id = `drawingCanvas${prompt.startedPlayerId}S${prompt.step}`;
              canv.width = 300;
              canv.height = 300;
              canv.style = "border: 1px black solid;";

              afterGameDiv.appendChild(canv); // adds the canvas

              const thisContext = canv.getContext("2d");
              const thisClickX = prompt.clickX
                .split(",")
                .map((n) => parseInt(n));
              const thisClickY = prompt.clickY
                .split(",")
                .map((n) => parseInt(n));
              const thisClickDrag = prompt.clickDrag
                .split(",")
                .map((b) => b === "true");
              redraw(thisContext, thisClickX, thisClickY, thisClickDrag);
            } else {
              const span = document.createElement("span");
              span.innerText = ` -- ${prompt.prompt} -- `;
              afterGameDiv.appendChild(span);
            }
          });
        });
      }
    </script>
  </head>
  <body onload="setUp()">
    <div id="duringGame">
      <div id="drawPrompt">
        Draw a picture for: <span id="picturePhrase"></span>
      </div>
      <canvas
        id="drawingCanvas"
        width="300"
        height="300"
        style="border: 1px black solid;"
      ></canvas>
      <div id="textPrompt"></div>
      <input type="text" id="inputPhrase" />
      <p></p>
      <button onclick="submit()" id="submitButton">Submit</button>
    </div>
    <div id="afterGame"></div>
  </body>
</html>
